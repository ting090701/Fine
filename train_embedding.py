from sentence_transformers import SentenceTransformer, InputExample, losses
from torch.utils.data import DataLoader
import os

# 1. 載入模型 (Nomic AI - 美國開源模型)
model_name = 'nomic-ai/nomic-embed-text-v1.5'

# ⚠️ 關鍵修正：必須加上 trust_remote_code=True 才能載入 Nomic 模型
# 另外，為了微調效果，我們可以指定前綴 (prefix)，這是 Nomic 的特色
print(f"🚀 正在下載/載入 {model_name}...")
model = SentenceTransformer(model_name, trust_remote_code=True)

# 2. 準備資料
# 注意：Nomic 模型建議在查詢前加上 'search_query: ' 前綴，但在微調時
# 通常直接輸入內容即可，或是依照您的 RAG 使用習慣保持一致。
train_examples = [
    # --- 拇趾外翻 (Hallux Valgus) 相關 ---
    InputExample(texts=['什麼是拇趾外翻?', '拇趾外翻是指腳背第一掌骨與大拇趾之間的關節呈現外凸彎曲的變形，典型症狀包括關節外凸、其餘腳趾擠壓變形及足部疼痛。']),
    InputExample(texts=['拇趾外翻最大的成因是什麼?', '根據醫學研究，遺傳是拇趾外翻最大的成因，腳型主要遺傳自父母或家族長輩。']),
    InputExample(texts=['穿高跟鞋會導致拇趾外翻嗎?', '長期穿著不正確的鞋子（如高跟鞋、尖頭鞋）是間接加劇因素，會對大拇趾造成擠壓，導致外翻惡化。']),
    InputExample(texts=['拇趾外翻嚴重程度如何分級?', '以HVA角度分級：正常(<15度)、輕度(15-25度)、中度(25-40度)、重度(>40度)。']),
    InputExample(texts=['輕微拇趾外翻該如何處理?', '輕微拇趾外翻可穿著保健鞋墊，並透過訓練腳部肌肉力量來改善。']),
    InputExample(texts=['中度拇趾外翻的治療建議是什麼?', '建議使用足部輔具（如矯正鞋墊、支架、分隔墊），搭配衛教運動改善角度，並避免穿著窄楦頭鞋款。']),
    InputExample(texts=['嚴重拇趾外翻一定要開刀嗎?', '嚴重拇趾外翻通常需要手術治療，但術後仍須穿著保健鞋墊並配合輔具及運動以避免復發。']),
    InputExample(texts=['拇趾外翻矯正套有效嗎?', '研究顯示若持續穿戴一年，最多可減少5度，雖然長期治療效果有限，但能緩解壓力，適合不適合開刀的老年人。']),
    InputExample(texts=['什麼樣的腳型容易拇趾外翻?', '足部拇趾與第二指間距過寬、拇趾韌帶較鬆、扁平足（旋內腳型）以及大拇趾較長的人較容易發生。']),
    InputExample(texts=['拇趾外翻會造成身體其他部位疼痛嗎?', '會，拇趾外翻導致腳掌不安定，可能引起膝蓋痛、肩膀痠痛、腰痛、偏頭痛及全身骨骼歪斜。']),
    InputExample(texts=['如果天生第一蹠骨內偏會怎樣?', '若天生第一蹠骨內偏，後天又穿著楦頭較窄的鞋子造成壓迫，非常容易形成拇趾外翻。']),
    InputExample(texts=['HVA和IMA角度分別代表什麼?', 'HVA是拇趾外翻角度(Hallux valgus angle)，IMA是第一蹠骨間角度(Intermetatarsal Angle)。']),

    # --- 扁平足 (Flat Feet) 相關 ---
    InputExample(texts=['什麼是扁平足?', '扁平足是指內側足弓過低甚至塌陷的足型，導致足部穩定度及吸震功能下降。']),
    InputExample(texts=['扁平足對身體有什麼影響?', '扁平足會使站立、跑步時承受負荷變大，足部的吸震、緩衝功能下降，容易導致疲勞及關節磨損。']),
    InputExample(texts=['幼兒為什麼會有扁平足?', '幼兒扁平足原因包括：足部太早承重（如坐學步車）、肌肉韌帶無力、發展遲緩或遺傳因素。']),
    InputExample(texts=['使用螃蟹車會導致扁平足嗎?', '會，讓未滿十個月的幼兒使用螃蟹車，會使足部在不穩定狀態下太早承重，導致足弓發育遲緩。']),
    InputExample(texts=['W型坐姿對腿型和足弓有什麼影響?', '長期W型坐姿會導致內八、X型腿及扁平足，因大腿內側肌肉緊縮，影響骨骼發育。']),
    InputExample(texts=['如何簡易觀察是否有扁平足?', '可透過「翹腳檢查」看足弓有無凹陷，或「立正站好」觀察內側足弓是否平貼地面及後足跟是否外翻。']),
    InputExample(texts=['扁平足的「僵硬型」和「柔軟型」有何不同?', '翹腳時若足弓無凹陷可能為結構型（僵硬性）；若坐著有足弓但站立消失則為功能型（柔軟性）。']),
    InputExample(texts=['成人扁平足會引發哪些症狀?', '容易引起足底筋膜炎、大腳趾變形、膝關節炎、腰酸背痛、脊柱側彎及長短腳等問題。']),
    InputExample(texts=['兒童扁平足什麼時候需要治療?', '若扁平足合併足外翻（後跟骨線內斜），應在3歲時給予特製鞋墊支撐；一般生理性扁平足可觀察至5-7歲。']),
    InputExample(texts=['扁平足有哪些運動訓練方法?', '包括赤足在沙地行走、學企鵝用腳跟走路、跳繩、用腳趾撿珠子或抓毛巾等。']),
    InputExample(texts=['為什麼肥胖會導致扁平足?', '體重過重會增加足部壓力，無論是兒童肥胖或成人懷孕、中老年發福，都可能使足弓變得較扁平。']),
    InputExample(texts=['扁平足需要開刀嗎?', '兒童很少需要手術，除非有嚴重變形或骨骼融合；成人則以鞋墊預防再傷害為主。']),
    InputExample(texts=['足弓發育的黃金時期是幾歲?', '2至10歲是足弓發育的黃金時期，應注意足部發展並避免錯誤姿勢。']),
    InputExample(texts=['如何判斷兒童是扁平足高危險群?', '讓兒童單腳站立並翹起大拇趾，若無法完成且足弓仍扁平（超過3歲），即為高危險群。']),

    # --- 高弓足 (High Arch / Pes Cavus) 相關 ---
    InputExample(texts=['什麼是高弓足?', '高弓足是指足部內側足弓異常過高（又稱空凹足），壓力點集中在前後兩端。']),
    InputExample(texts=['高弓足的人常見哪些困擾?', '常見困擾包括腳跟及蹠骨長繭、足底筋膜炎、爪狀趾、容易扭傷腳踝及肩頸痠痛。']),
    InputExample(texts=['高弓足為什麼容易腳踝扭傷?', '因為內側足弓過高，重心落在足部外側，一旦重心不穩就容易造成足踝外側韌帶拉傷。']),
    InputExample(texts=['高弓足與O型腿有關係嗎?', '有，高弓足因內側足弓過高，會使兩腳膝蓋向外擠壓，容易形成O型腿。']),
    InputExample(texts=['高弓足如何選擇鞋墊?', '需要具有三足弓支撐設計的鞋墊，以填補足弓空隙，增加接觸面積並分散前後掌壓力。']),
    InputExample(texts=['什麼是爪狀趾?', '爪狀趾常出現於高弓足患者，因肌肉神經張力不平衡，導致腳趾關節彎曲變形。']),

    # --- 足底筋膜炎與蹠痛 ---
    InputExample(texts=['足底筋膜炎的典型症狀是什麼?', '典型症狀是早晨下床第一步腳後跟劇烈疼痛，或久坐站起時感到疼痛。']),
    InputExample(texts=['足底筋膜炎的成因有哪些?', '過度使用（久站久走）、體重過重、扁平足或高弓足結構問題、以及老化導致脂肪墊萎縮。']),
    InputExample(texts=['如何緩解足底筋膜炎?', '避免久站、進行小腿及足底伸展運動（拉筋）、使用具支撐性的鞋墊分散壓力、冰敷或熱敷。']),
    InputExample(texts=['蹠痛和足底筋膜炎有什麼差別?', '蹠痛是「前足底」疼痛發炎，常覺得像踩到小石頭；足底筋膜炎疼痛主要在「後足底」或足跟。']),
    InputExample(texts=['什麼是蹠底神經瘤（莫頓氏神經瘤）?', '指蹠骨中間的神經組織因長期受擠壓摩擦而增生，造成前足劇痛，常因穿太窄的鞋子引起。']),
    InputExample(texts=['蹠痛的好發族群有哪些?', '跑者、跳躍運動員、常穿高跟鞋或夾腳拖的人是蹠痛的高風險族群。']),
    InputExample(texts=['如何預防雞眼和繭?', '穿著合腳寬楦的鞋子減少摩擦，使用足部輔具分散壓力，並穿襪子降低摩擦。']),
    InputExample(texts=['雞眼與繭有什麼不同?', '繭是死皮細胞堆積變硬；雞眼則像深入皮膚的小石頭，踩到地面會劇痛。']),

    # --- 腿型與步態 (Leg Shape & Gait) ---
    InputExample(texts=['什麼是鐘擺現象?', '指兒童腿型發育過程：嬰兒期O型腿 → 2歲變直 → 4歲X型腿 → 之後慢慢回正的自然生理現象。']),
    InputExample(texts=['小孩走路內八的原因是什麼?', '主要原因有三個：前足內收、脛骨內旋、髖關節過度內傾（大腿骨內轉）。']),
    InputExample(texts=['W型坐姿為什麼會導致X型腿?', 'W坐姿會使大腿內側韌帶緊縮、外側肌力不足，站立時膝蓋容易向內靠攏形成X型腿。']),
    InputExample(texts=['鞋底外側磨損嚴重代表什麼?', '通常代表有O型腿或高弓足，走路偏外側著地，對膝蓋和髖關節負擔較大。']),
    InputExample(texts=['鞋底內側磨損嚴重代表什麼?', '通常代表有扁平足，因足弓塌陷壓力集中在內側，容易引起腰部及脊椎不適。']),
    InputExample(texts=['穿高跟鞋走路對腰椎有什麼影響?', '穿高跟鞋會使骨盆前傾，腰椎弧度增加，壓力聚焦在腰椎第四、五節，導致腰痠背痛。']),
    InputExample(texts=['如何從鞋底磨損看足部健康?', '正常磨損應在腳尖和腳跟後方；若磨損集中在內側或外側，則顯示足部結構或步態可能有異常。']),
    InputExample(texts=['脛骨內旋造成的內八會好嗎?', '大多數脛骨內旋是生理性發育現象，通常會隨年齡自行復原，但若超過3歲且角度過大需評估治療。']),

    # --- 鞋子與鞋墊選擇 (Shoes & Insoles) ---
    InputExample(texts=['糖尿病患者選鞋要注意什麼?', '鞋頭要寬高（預留腳趾空間）、內襯無縫線避免磨腳、鞋跟硬度加強、前楦要有翹板設計。']),
    InputExample(texts=['什麼時間買鞋子最好?', '建議在黃昏或下午選購，因為經過一天活動後腳會稍微腫脹，此時試穿尺碼較準確。']),
    InputExample(texts=['如果左右腳大小不一樣怎麼買鞋?', '應以「較大」的那隻腳為標準，避免過緊磨腳，較小的一腳可透過鞋墊調整。']),
    InputExample(texts=['年長者選鞋的原則有哪些?', '應選防滑底、寬楦頭、鞋尖上翹（防絆倒）、鞋面能包覆足踝（如黏扣帶款）、鞋跟稍後傾。']),
    InputExample(texts=['好的鞋墊應該具備什麼功能?', '應具備三足弓支撐（內縱、外縱、橫弓）、減壓吸震功能，並能導正足部骨骼位置。']),
    InputExample(texts=['訂製鞋墊的使用壽命多久?', '兒童鞋墊約一年（需追蹤發育），成人鞋墊約一至二年，依使用頻率與保養狀況而定。']),
    InputExample(texts=['如何清潔保養矯正鞋墊?', '用清水或肥皂水手洗，軟毛刷輕刷，通風處陰乾。嚴禁使用洗衣機、烘乾機或熱風吹。']),
    InputExample(texts=['剛穿矯正鞋墊會痛正常嗎?', '剛開始穿戴會有1-2週適應期，若有破皮紅腫需回診調整；原理如同戴牙套，需時間將腳推回正確位置。']),
    InputExample(texts=['糖尿病患者為何需要專用鞋墊?', '因為糖尿病足感覺遲鈍且易感染，鞋墊需具備減壓功能，並針對傷口處挖空以避免壓迫潰瘍。']),
    InputExample(texts=['為什麼鞋子前楦要有翹板(Rocker)設計?', '翹板設計可以協助推進，降低行走時前足底的壓力，減少蹠痛與大拇趾關節負擔。']),
    InputExample(texts=['幼兒鞋子尺寸該如何預留?', '取出鞋墊量測，腳趾前方應預留約1.5公分（約一個大拇指寬）的空間。']),
    InputExample(texts=['為什麼不要穿太軟的鞋子?', '太軟的鞋子（如部分布鞋）缺乏支撐力，無法保護足弓與足踝，容易造成足部疲勞或受傷。']),

    # --- 急救與護理 (First Aid & Care) ---
    InputExample(texts=['腳踝扭傷急性期該如何處理?', '應遵循PRICE原則：保護(Protect)、休息(Rest)、冰敷(Icing)、加壓(Compression)、抬高(Elevation)。']),
    InputExample(texts=['扭傷後多久可以熱敷?', '通常在受傷72小時後，確認無紅腫熱痛，才可開始進行熱敷以促進血液循環。']),
    InputExample(texts=['如何預防凍甲(嵌甲)?', '不穿楦頭過窄的鞋子，修剪指甲時要「平剪」，不可往側邊指縫修剪過短。']),
    InputExample(texts=['為什麼糖尿病患者不能赤腳走路?', '因為神經病變導致感覺遲鈍，赤腳容易受傷且不易察覺，傷口癒合困難恐導致嚴重感染。']),
    InputExample(texts=['足部繭很厚可以直接剪掉嗎?', '不建議自行修剪，容易受傷感染。應透過穿著合適鞋具與鞋墊減少摩擦，或尋求專業處理。']),

    # --- 運動與復健 (Exercise & Rehab) ---
    InputExample(texts=['正確的走路姿勢是什麼?', '以腳跟先著地，重心移至腳掌，最後由腳尖推進；身體挺直，運用臀部與大腿肌肉。']),
    InputExample(texts=['小蝴蝶運動怎麼做?', '坐姿，兩腳底相貼，膝蓋彎曲，雙手輕壓膝蓋往地面方向震動，可伸展大腿內側肌肉，改善X型腿。']),
    InputExample(texts=['如何訓練前脛肌誘發足弓?', '可以練習用腳跟走路（學企鵝走路），能訓練前脛肌力量，幫助足弓形成。']),
    InputExample(texts=['有什麼遊戲可以幫助兒童足部發育?', '跳繩、踢足球、跳格子、用腳趾玩猜拳、抓毛巾等活動都能訓練足部小肌肉。']),
    InputExample(texts=['足底筋膜炎可以做什麼運動改善?', '可以做足底伸展（拉筋板或毛巾牽拉腳尖）、腳踝轉動運動，以及訓練足部抓地力。']),

    # --- Dr. Foot 專業服務相關 ---
    InputExample(texts=['Dr. Foot的鞋墊製作流程為何?', '先進行專業足部評估，取腳模（泡沫或石膏），依照個人足壓與問題修模，最後手工製作完成。']),
    InputExample(texts=['Dr. Foot的足部評估包含哪些內容?', '包括整體結構姿態評估、足部結構理學評估、電腦足形掃瞄量測及步態分析。']),
    InputExample(texts=['Dr. Foot鞋墊的適應期需要多久?', '一般約需1至2週，甚至一個月。若適應期間有任何不適或紅腫，提供免費調整服務。']),
    InputExample(texts=['為什麼選擇Dr. Foot而不是市售鞋墊?', 'Dr. Foot提供物理治療師專業評估與「量身訂製」，針對個人左右腳不同問題設計，非一般通用型產品。']),
    InputExample(texts=['多久需要回來複評一次足部狀況?', '建議每半年回來複評一次，追蹤足部結構變化與鞋墊效果，並確認是否需要調整。']),
    InputExample(texts=['Dr. Foot的鞋墊有保固嗎?', '舒活足鞋墊底層骨架耐用約5年，表面耗材若磨損可付費替換維修。']),
    InputExample(texts=['Dr. Foot有什麼認證或獎項?', '榮獲SNQ國家生技醫療品質獎、國家新創獎，並擁有多項國際專利及第一等級醫療器材許可。']),
    InputExample(texts=['小朋友做矯正鞋墊需要換鞋嗎?', '通常建議鞋墊可使用一年，期間需追蹤足部改善情況；鞋子則依腳長大速度更換，鞋墊可移至新鞋使用（需合適）。']),

    # --- 其他綜合問題 ---
    InputExample(texts=['足部健康對全身的影響是什麼?', '足部是地基，若有拇趾外翻或扁平足，可能引起膝痛、骨盆歪斜、脊椎側彎、肩頸痠痛等全身性問題。']),
    InputExample(texts=['什麼是假性長短腳?', '通常由骨盆傾斜或足部結構不對稱（如單側扁平足）引起，非腿骨實際長度不同，可透過鞋墊與運動改善。']),
    InputExample(texts=['為什麼懷孕後腳會變大或變扁?', '懷孕期間體重增加且賀爾蒙使韌帶鬆弛，導致足弓塌陷，使腳型變寬、變長或變扁。']),
    InputExample(texts=['如何自我檢測跟骨是否外翻?', '從背後觀察小腿中線與足跟中線是否呈一直線，若足跟中線向內傾斜（<）即為跟骨外翻。']),
    InputExample(texts=['糖尿病足為什麼容易截肢?', '因血管病變循環差、神經病變感覺喪失，小傷口易惡化成潰瘍壞疽，嚴重時需截肢保命。']),
    InputExample(texts=['為什麼老人家容易跌倒?', '除了肌力衰退，足部問題（如拇趾外翻、扁平足）導致平衡感變差、步態不穩也是主因。']),
    InputExample(texts=['足底壓力分析有什麼作用?', '可客觀顯示站立與行走時的壓力分佈，找出異常受力點（如高壓區），作為製作減壓鞋墊的依據。']),
    InputExample(texts=['什麼是橫弓塌陷?', '指前足橫向足弓無力塌陷，導致前腳掌變寬扁，容易長繭、蹠痛或形成爪狀趾。']),
    InputExample(texts=['為什麼穿夾腳拖容易腳痛?', '夾腳拖缺乏足弓支撐與包覆，需靠腳趾抓地，容易導致足底筋膜炎、蹠痛及爪狀趾。']),
    InputExample(texts=['如何判斷鞋子是否合腳?', '腳跟穩固不掉、腳趾前方留有1-1.5公分、鞋寬適中不壓迫兩側、足弓處有貼合支撐。']),
    InputExample(texts=['O型腿可以矯正嗎?', '兒童生理性O型腿會自然改善；病理性或成人O型腿則需透過鞋墊調整受力及特定運動來預防惡化。']),
    InputExample(texts=['為什麼走路會覺得腳底像踩到石頭?', '這通常是「蹠痛」或「雞眼」的症狀，代表前足某點受力過大或神經瘤增生。']),
    InputExample(texts=['足部輔具可以完全治癒拇趾外翻嗎?', '輔具主要功能是減緩惡化、矯正角度（輕中度）及減輕疼痛，重度變形仍需手術，但輔具對術後維持極重要。']),
    InputExample(texts=['為什麼需要分腳型選鞋墊?', '因為扁平足需支撐內側足弓，高弓足需填補空隙並減壓，不同腳型需求相反，通用鞋墊無法滿足。']),
    InputExample(texts=['長時間跪坐有什麼壞處?', '跪坐會阻礙足部血液循環，並可能影響兒童足弓與腿型發育。']),
    InputExample(texts=['足跟痛一定是足底筋膜炎嗎?', '不一定，也可能是跟骨滑液囊炎、脂肪墊萎縮、跟骨骨刺或神經壓迫，需專業評估鑑別。']),
    InputExample(texts=['如何預防運動傷害?', '穿著合適運動鞋與鞋墊、運動前充分熱身拉筋、運動後冰敷（若有發炎）及伸展放鬆。']),
    InputExample(texts=['什麼是Rocker shoes (搖擺鞋/船底鞋)?', '指鞋底呈弧形設計的鞋，能減少踝關節與蹠趾關節彎曲，適合關節炎或糖尿病足患者。']),
    InputExample(texts=['為什麼會有長短腳?', '原因包括先天腿骨長度不等（結構性）及骨盆歪斜或足部不對稱（功能性），後者可透過矯正改善。']),
    InputExample(texts=['鞋墊可以改善脊椎側彎嗎?', '若脊椎側彎是由長短腳或骨盆歪斜引起的，透過功能性鞋墊平衡下肢地基，可輔助改善脊椎曲線。']),
    InputExample(texts=['矽膠鞋墊有什麼優點?', '醫療級矽膠吸震力強、耐用、不易變形，適合需要高度減壓的族群（如久站、糖尿病足）。']),
    InputExample(texts=['為什麼高弓足不適合穿薄底鞋?', '高弓足缺乏吸震能力，穿薄底鞋會使地面反作用力直接衝擊足部與膝蓋，加重疼痛。'])
]

# 3. 建立 DataLoader
# RTX 3080 顯存充裕，若只有少量測試資料，batch_size=2 即可；
# 若有大量資料(>100筆)，建議設為 10 或 16。
train_dataloader = DataLoader(train_examples, shuffle=True, batch_size=2)

# 4. 定義損失函數 (MultipleNegativesRankingLoss 是 RAG 微調神器)
train_loss = losses.MultipleNegativesRankingLoss(model)

# 5. 開始微調
print("🔥 開始微調 Embedding 模型 (這可能需要幾分鐘)...")
output_path = './fine_tuned_embedding_model'

model.fit(
    train_objectives=[(train_dataloader, train_loss)],
    epochs=3,            # 資料少的話跑 3-5 輪
    warmup_steps=10,     # 預熱步數
    output_path=output_path,
    show_progress_bar=True
)

print(f"✅ 模型微調完成！已儲存至: {output_path}")
print("⚠️ 請記得：更換 Embedding 模型後，必須刪除舊的 db 資料夾並重跑 ingest.py！")

#pip install einops sentence-transformers
#python train_embedding.py